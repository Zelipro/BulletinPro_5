name: ğŸš€ Build BulletinPro_Pro Multi-Platform

on:
  push:
    branches: 
      - main
      - develop
    tags:
      - 'v*.*.*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  
  pull_request:
    branches: 
      - main
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  builder'
        required: false
        default: '1.0.0'

env:
  APP_NAME: BulletinPro_Pro
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout du code source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Installation de Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pillow
      shell: pwsh
    
    - name: ğŸ–¼ï¸ GÃ©nÃ©ration des icÃ´nes
      run: python scripts/create_icons.py
      shell: pwsh
    
    - name: ğŸ”¨ Compilation PyInstaller
      run: |
        pyinstaller --noconfirm --clean --name "BulletinPro_Prof" --windowed --onefile --icon "assets/icons/logo.ico" --add-data "config.py;." --add-data "assets/icons;assets/icons" --hidden-import "flet" --hidden-import "flet.core" --hidden-import "fpdf" --hidden-import "supabase" main.py
      shell: pwsh
    
    - name: ğŸ“¦ PrÃ©paration structure Windows
      run: python scripts/build_windows.py
      shell: pwsh
    
    - name: ğŸ› ï¸ Installation Inno Setup
      run: choco install innosetup -y --no-progress
      shell: pwsh
    
    - name: ğŸ CrÃ©ation installateur
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows.iss
      shell: pwsh
    
    - name: ğŸ“¤ Upload installateur Windows
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro_Prof-Windows-Installer
        path: dist/installers/BulletinPro_Prof_Setup_*.exe
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ“¤ Upload portable Windows
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro_Prof-Windows-Portable
        path: dist/BulletinPro_Prof.exe
        retention-days: 30
        if-no-files-found: warn

  build-linux:
    name: ğŸ§ Build Linux
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout du code source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Installation de Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Installation dÃ©pendances systÃ¨me
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y libgtk-3-0 libnotify4 dpkg-dev fakeroot
    
    - name: ğŸ“¦ Installation dÃ©pendances Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pillow
    
    - name: ğŸ–¼ï¸ GÃ©nÃ©ration des icÃ´nes
      run: python scripts/create_icons.py
    
    - name: ğŸ”¨ Compilation PyInstaller
      run: |
        pyinstaller --noconfirm --clean --name "bulletinpro_Prof" --windowed --onefile --icon "assets/icons/logo.png" --add-data "config.py:." --add-data "assets/icons:assets/icons" --hidden-import "flet" --hidden-import "flet.core" --hidden-import "fpdf" --hidden-import "supabase" main.py
    
    - name: ğŸ“¦ CrÃ©ation structure .deb
      run: python scripts/build_linux.py
    
    - name: ğŸ Build package .deb
      run: |
        cd dist
        dpkg-deb --build bulletinpro_prof-1.0.0
        mv bulletinpro_prof-1.0.0.deb BulletinPro_Prof-1.0.0-amd64.deb
    
    - name: ğŸ“¤ Upload package .deb
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Linux-DEB
        path: dist/BulletinPro_Prof-*.deb
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ“¤ Upload binaire Linux
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro_Prof-Linux-Binary
        path: dist/bulletinpro_prof
        retention-days: 30
        if-no-files-found: warn

  create-release:
    name: ğŸ‰ CrÃ©ation Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Windows Installer
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro_Prof-Windows-Installer
        path: ./release
    
    - name: ğŸ“¥ Download Linux Package
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro_Prof-Linux-DEB
        path: ./release
    
    - name: ğŸ‰ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ./release/*
        body: |
          ## ğŸ‰ BulletinPro ${{ github.ref_name }}
          
          ### ğŸ“¥ TÃ©lÃ©chargements
          
          **Windows** :
          - Installateur complet : `BulletinPro_Prof_Setup_*.exe`
          
          **Linux** :
          - Package Debian : `BulletinPro_Prof-*-amd64.deb`
          
          ### Installation
          
          **Windows** : Double-clic sur l'installateur
          **Linux** : `sudo dpkg -i BulletinPro_Prof-*.deb`
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
