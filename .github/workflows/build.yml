name: ğŸš€ Build BulletinPro-Prof Multi-Platform

on:
  push:
    branches: 
      - main
      - develop
    tags: 
      - 'v*.*.*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  
  pull_request:
    branches: 
      - main
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  builder (ex: 1.0.0)'
        required: false
        default: '1.0.0'

env:
  APP_NAME: BulletinPro-Prof
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  # ==================================================================
  # ======================= WINDOWS BUILD ============================
  # ==================================================================
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      
      - name: ğŸ“¦ Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # Installer backports.zoneinfo AVANT requirements.txt
          pip install "backports.zoneinfo;python_version<'3.9'" --no-build-isolation
          
          # Installer les autres dÃ©pendances
          pip install -r requirements.txt
          pip install pillow pyinstaller
          
          # âœ… CORRECTION : VÃ©rification simplifiÃ©e
          Write-Host "`n=== VÃ©rification de l'environnement ==="
          python -c "import sys; print(f'Python version: {sys.version}')"
          python -c "try:`n    import flet`n    print('âœ… Flet installÃ©')`nexcept:`n    print('âŒ Flet manquant')"
          Write-Host "âœ… Toutes les dÃ©pendances installÃ©es avec succÃ¨s"
      
      - name: ğŸ–¼ï¸ Generate icons
        shell: pwsh
        run: |
          if (!(Test-Path "assets/icons")) {
            New-Item -ItemType Directory -Force -Path "assets/icons"
          }
          python scripts/create_icons.py

      - name: ğŸ”¨ PyInstaller build
        shell: pwsh
        run: |
          if (!(Test-Path "BulletinPro-Prof.spec")) {
            Write-Error "âŒ BulletinPro-Prof.spec introuvable !"
            exit 1
          }
          
          Write-Host "âœ… Utilisation de BulletinPro-Prof.spec"
          pyinstaller --noconfirm --clean BulletinPro-Prof.spec
      
      - name: âœ… Verify executable
        shell: pwsh
        run: |
          $exePath = "dist/BulletinPro-Prof.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            Write-Host "âœ… Executable created: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "âŒ Executable not found!"
            exit 1
          }
      
      - name: ğŸ“¦ Prepare Windows folder structure
        shell: pwsh
        run: python scripts/build_windows.py
      
      - name: ğŸ› ï¸ Install Inno Setup
        shell: pwsh
        run: choco install innosetup -y --no-progress
      
      - name: ğŸ Create installer with Inno Setup
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version || github.ref_name || '1.0.0' }}"
          $version = $version -replace '^v', ''
          $version = $version -replace 'main', '1.0.0'
          $version = $version -replace 'develop', '1.0.0'
          
          if (-not ($version -match '^\d')) {
            $version = '1.0.0'
            Write-Host "âš ï¸ Version invalide, utilisation de 1.0.0"
          }
          
          Write-Host "âœ… Building installer version: $version"
          
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DAPP_VERSION=$version `
            installer/windows.iss
      
      - name: ğŸ“¤ Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Windows-Installer
          path: dist/installers/BulletinPro-Prof_Setup_*.exe
          retention-days: 30
          if-no-files-found: error
      
      - name: ğŸ“¤ Upload Windows portable exe
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Windows-Portable
          path: dist/BulletinPro-Prof.exe
          retention-days: 30
          if-no-files-found: error

  # ==================================================================
  # ======================= LINUX BUILD ==============================
  # ==================================================================
  build-linux:
    name: ğŸ§ Build Linux (DEB)
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      
      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            libgtk-3-0 \
            libnotify4 \
            dpkg-dev \
            fakeroot \
            patchelf \
            libncurses6 \
            libncursesw6 \
            libtinfo6 \
            desktop-file-utils
      
      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pillow pyinstaller
          
          # âœ… CORRECTION : VÃ©rification simplifiÃ©e
          echo "=== VÃ©rification de l'environnement ==="
          python -c "import sys; print(f'Python version: {sys.version}')"
          python -c "try:
              import flet
              print('âœ… Flet installÃ©')
          except:
              print('âŒ Flet manquant')"
          echo "âœ… Toutes les dÃ©pendances installÃ©es avec succÃ¨s"
      
      - name: ğŸ–¼ï¸ Generate icons
        run: |
          mkdir -p assets/icons
          python scripts/create_icons.py
      
      - name: ğŸ”¨ PyInstaller build
        run: |
          pyinstaller --noconfirm --clean \
            --name "bulletinpro-prof" \
            --windowed --onefile \
            --icon "assets/icons/logo.png" \
            --add-data "config.py:." \
            --add-data "assets/icons:assets/icons" \
            --hidden-import flet \
            --hidden-import flet.core \
            --hidden-import flet_core \
            --hidden-import flet_runtime \
            --hidden-import supabase \
            --hidden-import PIL \
            --hidden-import sqlite3 \
            --collect-all flet \
            --collect-all flet_core \
            --collect-all flet_runtime \
            main.py
      
      - name: âœ… Verify executable
        run: |
          if [ -f "dist/bulletinpro-prof" ]; then
            chmod +x dist/bulletinpro-prof
            size=$(du -h dist/bulletinpro-prof | cut -f1)
            echo "âœ… Executable created: $size"
          else
            echo "âŒ Executable not found!"
            exit 1
          fi

      - name: ğŸ“¦ Create DEB package structure
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name || '1.0.0' }}"
          VERSION=${VERSION#v}
          VERSION=${VERSION//main/1.0.0}
          VERSION=${VERSION//develop/1.0.0}
          
          if [[ ! $VERSION =~ ^[0-9] ]]; then
            VERSION="1.0.0"
            echo "âš ï¸ Version invalide, utilisation de 1.0.0"
          fi
          
          echo "âœ… Version validÃ©e: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          python scripts/build_linux.py "$VERSION"

      - name: ğŸ—ï¸ Build DEB package
        run: |
          VERSION=${{ env.VERSION }}
          echo "âœ… Building DEB version: $VERSION"
          
          cd dist
          
          if [ -d "bulletinpro-prof-$VERSION" ]; then
            PKG_DIR="bulletinpro-prof-$VERSION"
          else
            echo "âŒ Package directory not found!"
            echo "ğŸ“‚ Contenu de dist/ :"
            ls -la
            exit 1
          fi
          
          echo "ğŸ“‹ Contenu du fichier control :"
          cat "$PKG_DIR/DEBIAN/control"
          echo ""
          
          chmod 644 "$PKG_DIR/DEBIAN/control"
          
          echo "ğŸ”¨ Construction du paquet .deb..."
          fakeroot dpkg-deb --build "$PKG_DIR"
          
          mv "${PKG_DIR}.deb" "BulletinPro-Prof_${VERSION}_amd64.deb"
          
          if [ -f "BulletinPro-Prof_${VERSION}_amd64.deb" ]; then
            size=$(du -h "BulletinPro-Prof_${VERSION}_amd64.deb" | cut -f1)
            echo "âœ… DEB package created: $size"
            echo ""
            echo "ğŸ“‹ Informations du paquet :"
            dpkg-deb --info "BulletinPro-Prof_${VERSION}_amd64.deb"
          else
            echo "âŒ DEB package creation failed!"
            exit 1
          fi
      
      - name: ğŸ“¤ Upload DEB package
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Linux-DEB
          path: dist/BulletinPro-Prof_*_amd64.deb
          retention-days: 30
          if-no-files-found: error
      
      - name: ğŸ“¤ Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Linux-Binary
          path: dist/bulletinpro-prof
          retention-days: 30
          if-no-files-found: error

  # ==================================================================
  # ========================= RELEASE ================================
  # ==================================================================
  create-release:
    name: ğŸ‰ Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: ğŸ“‚ List files (debug)
        run: |
          echo "=== Artifacts structure ==="
          ls -R ./artifacts
          echo "==========================="
      
      - name: ğŸ“‹ Prepare release files
        run: |
          mkdir -p ./release
          find ./artifacts -type f \( -name "*.exe" -o -name "*.deb" \) -exec cp {} ./release/ \;
          echo "=== Release files ==="
          ls -lh ./release
          echo "===================="
      
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          body: |
            ## ğŸš€ BulletinPro-Prof ${{ github.ref_name }}
            
            ### ğŸ“¥ TÃ©lÃ©chargements disponibles
            
            #### ğŸªŸ Windows
            - **Installateur complet** : `BulletinPro-Prof_Setup_*.exe`
            - **Version portable** : `BulletinPro-Prof.exe`
            
            #### ğŸ§ Linux (Ubuntu/Debian)
            - **Package Debian** : `BulletinPro-Prof_*_amd64.deb`
            - **Binaire standalone** : `bulletinpro-prof`
            
            ### ğŸ“‹ PrÃ©requis
            
            **Windows** : Windows 10/11 (64-bit)
            **Linux** : Ubuntu 20.04+, Debian 11+
            
            ### ğŸ†• NouveautÃ©s
            
            - Synchronisation cloud avec Supabase
            - Interface utilisateur amÃ©liorÃ©e
            - Gestion multi-plateforme des donnÃ©es
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
