name: üöÄ Build BulletinPro-Prof Multi-Platform

on:
  push:
    branches: 
      - main
      - develop
    tags: 
      - 'v*.*.*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  
  pull_request:
    branches: 
      - main
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Version √† builder (ex: 1.0.0)'
        required: false
        default: '1.0.0'

env:
  APP_NAME: BulletinPro-Prof
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  # ==================================================================
  # ======================= WINDOWS BUILD ============================
  # ==================================================================
  build-windows:
    name: ü™ü Build Windows
    runs-on: windows-latest
    timeout-minutes: 45
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      
      - name: üì¶ Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pillow pyinstaller
          pip install backports.zoneinfo importlib-metadata
      
      - name: üñºÔ∏è Generate icons
        shell: pwsh
        run: |
          if (!(Test-Path "assets/icons")) {
            New-Item -ItemType Directory -Force -Path "assets/icons"
          }
          python scripts/create_icons.py
      
      - name: üî® PyInstaller build
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean `
            --name "BulletinPro-Prof" `
            --windowed --onefile `
            --icon "assets/icons/logo.ico" `
            --add-data "config.py;." `
            --add-data "assets/icons;assets/icons" `
            --hidden-import flet `
            --hidden-import flet.core `
            --hidden-import flet_core `
            --hidden-import flet_runtime `
            --hidden-import supabase `
            --hidden-import PIL `
            --hidden-import sqlite3 `
            --collect-all flet `
            --collect-all flet_core `
            --collect-all flet_runtime `
            main.py
      
      - name: ‚úÖ Verify executable
        shell: pwsh
        run: |
          $exePath = "dist/BulletinPro-Prof.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            Write-Host "‚úÖ Executable created: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "‚ùå Executable not found!"
            exit 1
          }
      
      - name: üì¶ Prepare Windows folder structure
        shell: pwsh
        run: python scripts/build_windows.py
      
      - name: üõ†Ô∏è Install Inno Setup
        shell: pwsh
        run: choco install innosetup -y --no-progress
      
      - name: üéÅ Create installer with Inno Setup
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version || github.ref_name || '1.0.0' }}"
          $version = $version -replace '^v', ''
          Write-Host "Building installer version: $version"
          
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DAPP_VERSION=$version `
            installer/windows.iss
      
      - name: üì§ Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Windows-Installer
          path: dist/installers/BulletinPro-Prof_Setup_*.exe
          retention-days: 30
          if-no-files-found: error
      
      - name: üì§ Upload Windows portable exe
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Windows-Portable
          path: dist/BulletinPro-Prof.exe
          retention-days: 30
          if-no-files-found: error

  # ==================================================================
  # ======================= LINUX BUILD ==============================
  # ==================================================================
  build-linux:
    name: üêß Build Linux (DEB)
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      
      - name: üì¶ Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            libgtk-3-0 \
            libnotify4 \
            dpkg-dev \
            fakeroot \
            patchelf \
            libncurses6 \
            libncursesw6 \
            libtinfo6 \
            desktop-file-utils
      
      - name: üì¶ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pillow pyinstaller
      
      - name: üñºÔ∏è Generate icons
        run: |
          mkdir -p assets/icons
          python scripts/create_icons.py
      
      - name: üî® PyInstaller build
        run: |
          pyinstaller --noconfirm --clean \
            --name "bulletinpro-prof" \
            --windowed --onefile \
            --icon "assets/icons/logo.png" \
            --add-data "config.py:." \
            --add-data "assets/icons:assets/icons" \
            --hidden-import flet \
            --hidden-import flet.core \
            --hidden-import flet_core \
            --hidden-import flet_runtime \
            --hidden-import supabase \
            --hidden-import PIL \
            --hidden-import sqlite3 \
            --collect-all flet \
            --collect-all flet_core \
            --collect-all flet_runtime \
            main.py
      
      - name: ‚úÖ Verify executable
        run: |
          if [ -f "dist/bulletinpro-prof" ]; then
            chmod +x dist/bulletinpro-prof
            size=$(du -h dist/bulletinpro-prof | cut -f1)
            echo "‚úÖ Executable created: $size"
          else
            echo "‚ùå Executable not found!"
            exit 1
          fi
          
      #==================================
      - name: üì¶ Create DEB package structure
        run: |
          # ‚úÖ Extraire et nettoyer la version
          VERSION="${{ github.event.inputs.version || github.ref_name || '1.0.0' }}"
          VERSION="${VERSION#v}"
          
          # ‚úÖ Si c'est une branche, utiliser 1.0.0
          if [[ "$VERSION" == "main" ]] || [[ "$VERSION" == "develop" ]]; then
            VERSION="1.0.0"
          fi
          
          echo "Package version: $VERSION"
          python scripts/build_linux.py "$VERSION"
      #==================================
      #----------------------------------
      - name: üèóÔ∏è Build DEB package
        run: |
          # ‚úÖ CORRECTION : Extraire la version correctement
          VERSION="${{ github.event.inputs.version || github.ref_name || '1.0.0' }}"
          VERSION="${VERSION#v}"  # Supprimer le 'v' au d√©but si pr√©sent
          
          # ‚úÖ Si c'est "main" ou une branche, utiliser 1.0.0 par d√©faut
          if [[ "$VERSION" == "main" ]] || [[ "$VERSION" == "develop" ]]; then
            VERSION="1.0.0"
          fi
          
          echo "Building DEB version: $VERSION"
          
          cd dist
          
          # V√©rifier que le dossier existe
          if [ -d "bulletinpro-prof-$VERSION" ]; then
            PKG_DIR="bulletinpro-prof-$VERSION"
          else
            echo "‚ùå Package directory not found!"
            ls -la
            exit 1
          fi
          
          # Construire le .deb
          fakeroot dpkg-deb --build "$PKG_DIR"
          
          # Renommer proprement
          mv "${PKG_DIR}.deb" "BulletinPro-Prof_${VERSION}_amd64.deb"
          
          # V√©rifier
          if [ -f "BulletinPro-Prof_${VERSION}_amd64.deb" ]; then
            size=$(du -h "BulletinPro-Prof_${VERSION}_amd64.deb" | cut -f1)
            echo "‚úÖ DEB package created: $size"
            dpkg-deb --info "BulletinPro-Prof_${VERSION}_amd64.deb"
          else
            echo "‚ùå DEB package creation failed!"
            exit 1
          fi
            #----------------------------------
      - name: üì§ Upload DEB package
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Linux-DEB
          path: dist/BulletinPro-Prof_*_amd64.deb
          retention-days: 30
          if-no-files-found: error
      
      - name: üì§ Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Linux-Binary
          path: dist/bulletinpro-prof
          retention-days: 30
          if-no-files-found: error

  # ==================================================================
  # ========================= RELEASE ================================
  # ==================================================================
  create-release:
    name: üéâ Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üì• Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: üìÇ List files (debug)
        run: |
          echo "=== Artifacts structure ==="
          ls -R ./artifacts
          echo "==========================="
      
      - name: üìã Prepare release files
        run: |
          mkdir -p ./release
          find ./artifacts -type f \( -name "*.exe" -o -name "*.deb" \) -exec cp {} ./release/ \;
          echo "=== Release files ==="
          ls -lh ./release
          echo "===================="
      
      - name: üéâ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          body: |
            ## üöÄ BulletinPro-Prof ${{ github.ref_name }}
            
            ### üì• T√©l√©chargements disponibles
            
            #### ü™ü Windows
            - **Installateur complet** : `BulletinPro-Prof_Setup_*.exe`
              - Installation guid√©e avec raccourcis
              - Recommand√© pour la plupart des utilisateurs
            - **Version portable** : `BulletinPro-Prof.exe`
              - Aucune installation requise
              - Id√©al pour cl√© USB
            
            #### üêß Linux (Ubuntu/Debian)
            - **Package Debian** : `BulletinPro-Prof_*_amd64.deb`
              - Pour Ubuntu 20.04+, Debian 11+
              - Installation : `sudo dpkg -i BulletinPro-Prof_*.deb`
            - **Binaire standalone** : `bulletinpro-prof`
              - Ex√©cutable direct
              - N√©cessite : `chmod +x bulletinpro-prof && ./bulletinpro-prof`
            
            ### üìã Pr√©requis
            
            **Windows** : Windows 10/11 (64-bit)
            **Linux** : Ubuntu 20.04+, Debian 11+, ou distributions compatibles
            
            ### üÜï Nouveaut√©s de cette version
            
            - Synchronisation cloud avec Supabase
            - Interface utilisateur am√©lior√©e
            - Gestion multi-plateforme des donn√©es
            - Corrections de bugs et optimisations
            
            ### üìö Documentation
            
            - [Guide d'utilisation](https://github.com/${{ github.repository }}/wiki)
            - [FAQ](https://github.com/${{ github.repository }}/wiki/FAQ)
            - [Rapporter un bug](https://github.com/${{ github.repository }}/issues)
            
            ---
            
            **Note** : Cette version est destin√©e aux enseignants (saisie de notes).
            Pour la version administrateur compl√®te, consultez [BulletinPro](https://github.com/Zelipro/BulletinPro).
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
