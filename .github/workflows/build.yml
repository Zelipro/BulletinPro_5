name: ğŸš€ Build BulletinPro-Prof Multi-Platform

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*.*.*' ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  builder (ex: 1.2.3)'
        required: false
        default: '1.0.0'

env:
  APP_NAME: BulletinPro-Prof
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  # ==================================================================
  # ======================= WINDOWS BUILD =============================
  # ==================================================================
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    timeout-minutes: 40

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ğŸ“¦ Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt pillow pyinstaller inno-setup

      - name: ğŸ–¼ï¸ Generate icons
        shell: pwsh
        run: python scripts/create_icons.py

      - name: ğŸ”¨ PyInstaller build
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean `
            --name "BulletinPro-Prof" `
            --windowed --onefile `
            --icon "assets/icons/logo.ico" `
            --add-data "config.py;." `
            --add-data "assets/icons;assets/icons" `
            --hidden-import flet --hidden-import flet.core `
            --hidden-import fpdf --hidden-import supabase `
            main.py

      - name: ğŸ“¦ Prepare Windows folder structure
        shell: pwsh
        run: python scripts/build_windows.py

      - name: ğŸ Create installer with Inno Setup
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows.iss

      - name: ğŸ“¤ Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Windows-Installer
          path: dist/installers/BulletinPro-Prof_Setup_*.exe
          retention-days: 30

      - name: ğŸ“¤ Upload Windows portable exe
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Windows-Portable
          path: dist/BulletinPro-Prof.exe
          retention-days: 30

  # ==================================================================
  # ======================= LINUX BUILD ===============================
  # ==================================================================
  build-linux:
    name: ğŸ§ Build Linux (DEB + AppImage)
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libgtk-3-0 libnotify4 dpkg-dev fakeroot patchelf \
                                  libncurses6 libncursesw6 libtinfo6 \
                                  wget xz-utils desktop-file-utils

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pillow pyinstaller

      - name: ğŸ–¼ï¸ Generate icons
        run: python scripts/create_icons.py

      - name: ğŸ”¨ PyInstaller build
        run: |
          pyinstaller --noconfirm --clean \
            --name "bulletinpro-prof" \
            --windowed --onefile \
            --icon "assets/icons/logo.png" \
            --add-data "config.py:." \
            --add-data "assets/icons:assets/icons" \
            --hidden-import flet --hidden-import flet.core \
            --hidden-import fpdf --hidden-import supabase \
            main.py

      - name: ğŸ“¦ Create DEB package
        run: python scripts/build_linux.py

      - name: ğŸ—ï¸ Build DEB
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name || '1.0.0' }}
          VERSION=${VERSION#v}
          cd dist
          fakeroot dpkg-deb --build bulletinpro-prof-"$VERSION"
          mv bulletinpro-prof-"$VERSION".deb BulletinPro-Prof_"$VERSION"_amd64.deb

      - name: ğŸ—ï¸ Build AppImage (bonus)
        uses: AppImage/appimage-builder-action@v1
        with:
          recipe: .appimage/AppImageBuilder.yml  # tu crÃ©es ce fichier si tu veux l'AppImage
          # ou simplement skip si tu nâ€™en veux pas

      - name: ğŸ“¤ Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Linux-DEB
          path: dist/BulletinPro-Prof_*.deb

      - name: ğŸ“¤ Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: BulletinPro-Prof-Linux-Binary
          path: dist/bulletinpro-prof

  # ==================================================================
  # ========================= RELEASE =================================
  # ==================================================================
  create-release:
    name: ğŸ‰ Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸ“‚ List files (debug)
        run: ls -R ./artifacts

      - name: ğŸ‰ Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./artifacts/**/*
          body: |
            ## ğŸš€ BulletinPro-Prof ${{ github.ref_name }}

            ### ğŸ“¥ TÃ©lÃ©chargements

            **Windows**
            - Installateur : `BulletinPro-Prof_Setup_*.exe`
            - Version portable : `BulletinPro-Prof.exe`

            **Linux**
            - Package Debian/Ubuntu : `BulletinPro-Prof_*_amd64.deb`
            - ExÃ©cutable standalone : `bulletinpro-prof`

            ### Installation
            Windows â†’ double-clic sur l'installateur  
            Linux â†’ `sudo dpkg -i BulletinPro-Prof_*.deb`
          draft: false
          prerelease: false
