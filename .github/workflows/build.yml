name: ğŸš€ Build BulletinPro Multi-Platform

on:
  push:
    branches: 
      - main
      - develop
    tags:
      - 'v*.*.*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  
  pull_request:
    branches: 
      - main
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  builder'
        required: false
        default: '1.0.0'

env:
  APP_NAME: BulletinPro_Prof
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout du code source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Installation de Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install flet-desktop --force-reinstall
        pip install pillow
        pip install pyinstaller
      shell: pwsh
    
    - name: ğŸ” VÃ©rification de flet-desktop
      run: |
        Write-Host "=== Verification de flet-desktop ==="
        python -c "import flet_desktop; print('âœ“ flet-desktop importe avec succes')"
        pip show flet-desktop
      shell: pwsh
    
    - name: ğŸ–¼ï¸ GÃ©nÃ©ration des icÃ´nes
      run: python scripts/create_icons.py
      shell: pwsh
    
    - name: ğŸ” VÃ©rification des icÃ´nes crÃ©Ã©es
      run: |
        Write-Host "=== Verification des icones ==="
        Get-ChildItem -Path "assets\icons\*.ico" -Recurse | ForEach-Object { 
          Write-Host "âœ“ $_" 
        }
        if (Test-Path "assets\icons\logo.ico") {
          Write-Host "âœ“ logo.ico trouvÃ©"
        } else {
          Write-Host "âœ— logo.ico MANQUANT"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ”¨ Compilation PyInstaller
      run: |
        pyinstaller --noconfirm --clean `
          --name "BulletinPro_Prof" `
          --windowed `
          --onefile `
          --icon "assets/icons/logo.ico" `
          --add-data "config.py;." `
          --add-data "assets/icons;assets/icons" `
          --hidden-import "flet" `
          --hidden-import "flet.core" `
          --hidden-import "flet_core" `
          --hidden-import "flet_runtime" `
          --hidden-import "flet_desktop" `
          --hidden-import "fpdf" `
          --hidden-import "supabase" `
          --hidden-import "postgrest" `
          --hidden-import "PIL" `
          --hidden-import "sqlite3" `
          --collect-all "flet" `
          --collect-all "flet_core" `
          --collect-all "flet_runtime" `
          main.py
      shell: pwsh
    
    - name: ğŸ” VÃ©rification de l'exÃ©cutable
      run: |
        Write-Host "=== Verification de l'executable ==="
        if (Test-Path "dist\BulletinPro.exe") {
          $size = (Get-Item "dist\BulletinPro.exe").Length / 1MB
          Write-Host "âœ“ BulletinPro.exe : $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âœ— BulletinPro.exe MANQUANT"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ“¦ PrÃ©paration structure Windows
      run: python scripts/build_windows.py
      shell: pwsh
    
    - name: ğŸ” VÃ©rification du package
      run: |
        Write-Host "=== Contenu du package ==="
        Get-ChildItem -Path "dist\BulletinPro_Package" -Recurse | ForEach-Object {
          Write-Host "  $_"
        }
      shell: pwsh
    
    - name: ğŸ› ï¸ Installation Inno Setup
      run: choco install innosetup -y --no-progress
      shell: pwsh
    
    - name: ğŸ CrÃ©ation installateur
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows.iss
      shell: pwsh
    
    - name: ğŸ“¤ Upload installateur Windows
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Windows-Installer
        path: dist/installers/BulletinPro_Setup_*.exe
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ“¤ Upload portable Windows
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Windows-Portable
        path: dist/BulletinPro.exe
        retention-days: 30
        if-no-files-found: warn

  build-linux:
    name: ğŸ§ Build Linux
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout du code source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Installation de Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Installation dÃ©pendances systÃ¨me
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y libgtk-3-0 libnotify4 dpkg-dev fakeroot
    
    - name: ğŸ“¦ Installation dÃ©pendances Python
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install flet-desktop --force-reinstall
        pip install pillow
        pip install pyinstaller
    
    - name: ğŸ” VÃ©rification de flet-desktop
      run: |
        echo "=== VÃ©rification de flet-desktop ==="
        python -c "import flet_desktop; print('âœ“ flet-desktop importÃ© avec succÃ¨s')"
        pip show flet-desktop
    
    - name: ğŸ–¼ï¸ GÃ©nÃ©ration des icÃ´nes
      run: python scripts/create_icons.py
    
    - name: ğŸ”¨ Compilation PyInstaller
      run: |
        pyinstaller --noconfirm --clean \
          --name "bulletinpro" \
          --windowed \
          --onefile \
          --icon "assets/icons/app_icon.png" \
          --add-data "config.py:." \
          --add-data "assets/icons:assets/icons" \
          --hidden-import "flet" \
          --hidden-import "flet.core" \
          --hidden-import "flet_core" \
          --hidden-import "flet_runtime" \
          --hidden-import "flet_desktop" \
          --hidden-import "fpdf" \
          --hidden-import "supabase" \
          --hidden-import "postgrest" \
          --hidden-import "PIL" \
          --hidden-import "sqlite3" \
          --collect-all "flet" \
          --collect-all "flet_core" \
          --collect-all "flet_runtime" \
          main.py
    
    - name: ğŸ” VÃ©rification du binaire
      run: |
        echo "=== VÃ©rification du binaire ==="
        if [ -f "dist/bulletinpro" ]; then
          chmod +x dist/bulletinpro
          size=$(du -h dist/bulletinpro | cut -f1)
          echo "âœ“ bulletinpro : $size"
        else
          echo "âœ— bulletinpro MANQUANT"
          exit 1
        fi
    
    - name: ğŸ“¦ CrÃ©ation structure .deb
      run: python scripts/build_linux.py
    
    - name: ğŸ Build package .deb
      run: |
        cd dist
        dpkg-deb --build bulletinpro-1.0.0
        mv bulletinpro-1.0.0.deb BulletinPro-1.0.0-amd64.deb
    
    - name: ğŸ“¤ Upload package .deb
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Linux-DEB
        path: dist/BulletinPro-*.deb
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ“¤ Upload binaire Linux
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Linux-Binary
        path: dist/bulletinpro
        retention-days: 30
        if-no-files-found: warn

  create-release:
    name: ğŸ‰ CrÃ©ation Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Windows Installer
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Windows-Installer
        path: ./release
    
    - name: ğŸ“¥ Download Linux Package
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Linux-DEB
        path: ./release
    
    - name: ğŸ‰ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ./release/*
        body: |
          ## ğŸ‰ BulletinPro ${{ github.ref_name }}
          
          ### ğŸ“¥ TÃ©lÃ©chargements
          
          **Windows** :
          - Installateur complet : `BulletinPro_Setup_*.exe`
          
          **Linux** :
          - Package Debian : `BulletinPro-*-amd64.deb`
          
          ### Installation
          
          **Windows** : Double-clic sur l'installateur
          **Linux** : `sudo dpkg -i BulletinPro-*.deb`
          
          ### âœ… Corrections
          - RÃ©solution du problÃ¨me flet-desktop au dÃ©marrage
          - Optimisation de la taille de l'exÃ©cutable
          - AmÃ©lioration de la stabilitÃ©
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
